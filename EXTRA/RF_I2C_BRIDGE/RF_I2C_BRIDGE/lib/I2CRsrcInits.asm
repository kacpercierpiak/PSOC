;;*****************************************************************************
;;*****************************************************************************
;;  FILENAME: I2C.asm
;;  Version: 2.00, Updated on 2015/3/4 at 22:26:25
;;  Generated by PSoC Designer 5.4.3191
;;
;;  DESCRIPTION: I2Cs User Module software implementation file
;;
;;  NOTE: User Module APIs conform to the fastcall16 convention for marshalling
;;        arguments and observe the associated "Registers are volatile" policy.
;;        This means it is the caller's responsibility to preserve any values
;;        in the X and A registers that are still needed after the API functions
;;        returns. For Large Memory Model devices it is also the caller's 
;;        responsibility to perserve any value in the CUR_PP, IDX_PP, MVR_PP and 
;;        MVW_PP registers. Even though some of these registers may not be modified
;;        now, there is no guarantee that will remain the case in future releases.
;;-----------------------------------------------------------------------------
;;  Copyright (c) Cypress Semiconductor 2015. All Rights Reserved.
;;*****************************************************************************
;;*****************************************************************************

include "m8c.inc"
include "memory.inc"
include "I2CCommon.inc"
include "PSoCGPIOINT.inc"
include "PSoCAPI.inc"

;-----------------------------------------------
; include instance specific register definitions
;-----------------------------------------------

;-----------------------------------------------
;  Global Symbols
;-----------------------------------------------
;-------------------------------------------------------------------
;  Declare the functions global for both assembler and C compiler.
;
;  Note that there are two names for each API. First name is
;  assembler reference. Name with underscore is name refence for
;  C compiler.  Calling function in C source code does not require
;  the underscore.
;-------------------------------------------------------------------

export    I2C_ResumeInt
export   _I2C_ResumeInt
export    I2C_EnableInt
export   _I2C_EnableInt
export    I2C_ClearInt
export   _I2C_ClearInt
IF (I2C_MUM_SEL & (I2C_SLAVE | I2C_MMS))
export    I2C_EnableSlave
export   _I2C_EnableSlave
ENDIF
IF (I2C_MUM_SEL & (I2C_MSTR | I2C_MMS))
export    I2C_EnableMstr
export   _I2C_EnableMstr
ENDIF
export    I2C_Start
export   _I2C_Start
export    I2C_DisableInt
export   _I2C_DisableInt
IF (I2C_MUM_SEL & (I2C_SLAVE | I2C_MMS))
export    I2C_DisableSlave
export   _I2C_DisableSlave
ENDIF
IF (I2C_MUM_SEL & (I2C_MSTR | I2C_MMS))
export    I2C_DisableMstr
export   _I2C_DisableMstr
ENDIF
export    I2C_Stop
export   _I2C_Stop

IF (I2C_MUM_SEL & (I2C_SLAVE | I2C_MMS))
 IF (I2C_CY8C22x45)
export    I2C_EnableHWAddrCheck
export   _I2C_EnableHWAddrCheck
export    I2C_DisableHWAddrCheck
export   _I2C_DisableHWAddrCheck
 ENDIF
ENDIF

AREA UserModules (ROM, REL)

.SECTION

;-----------------------------------------------------------------------------
;  FUNCTION NAME: I2C_Start
;
;  DESCRIPTION:
;   Initialize the I2C I2C bus interface.
;
;-----------------------------------------------------------------------------
;
;  ARGUMENTS:
;
;  RETURNS: none
;
;  SIDE EFFECTS:
;    The A and X registers may be modified by this or future implementations
;    of this function.  The same is true for all RAM page pointer registers in
;    the Large Memory Model.  When necessary, it is the calling function's
;    responsibility to perserve their values across calls to fastcall16 
;    functions.
;          
 I2C_Start:
_I2C_Start:
    RAM_PROLOGUE RAM_USE_CLASS_1
IF (I2C_MUM_SEL & (I2C_SLAVE | I2C_MMS))
 IF (I2C_CY8C22x45)
   M8C_SetBank1
   mov   reg[I2C_ADDR], I2C_SLAVE_ADDR;I2C_HW_ADDR_EN
   M8C_SetBank0
 ENDIF
ENDIF
    RAM_EPILOGUE RAM_USE_CLASS_1
    ret
.ENDSECTION

.SECTION
;-----------------------------------------------------------------------------
;  FUNCTION NAME: I2C_ResumeInt
;
;  DESCRIPTION:
;     reEnables SDA interrupt allowing start condition detection. 
;     Skips clearing INT_CLR3 by entering the EnableInt at ResumeIntEntry:.
;     Remember to call the global interrupt enable function by using
;     the macro: M8C_EnableGInt.
;-----------------------------------------------------------------------------
;  ARGUMENTS: none
;
;  RETURNS: none
;
;  SIDE EFFECTS:
;    The A and X registers may be modified by this or future implementations
;    of this function.  The same is true for all RAM page pointer registers in
;    the Large Memory Model.  When necessary, it is the calling function's
;    responsibility to perserve their values across calls to fastcall16 
;    functions.
;-----------------------------------------------------------------------------
 I2C_ResumeInt:
_I2C_ResumeInt:
    RAM_PROLOGUE RAM_USE_CLASS_1
    jmp ResumeIntEntry
    
;-----------------------------------------------------------------------------
;  FUNCTION NAME: I2C_EnableInt
;
;  DESCRIPTION:
;     Enables SDA interrupt allowing start condition detection. Remember to call the
;     global interrupt enable function by using the macro: M8C_EnableGInt.
;
;-----------------------------------------------------------------------------
;
;  ARGUMENTS: none
;
;  RETURNS: none
;
;  SIDE EFFECTS:
;    The A and X registers may be modified by this or future implementations
;    of this function.  The same is true for all RAM page pointer registers in
;    the Large Memory Model.  When necessary, it is the calling function's
;    responsibility to perserve their values across calls to fastcall16 
;    functions.
;-----------------------------------------------------------------------------
 I2C_EnableInt:
_I2C_EnableInt:
    RAM_PROLOGUE RAM_USE_CLASS_1
    ;first clear any pending interrupts
    M8C_ClearIntFlag INT_CLR3, I2C_INT_MASK
ResumeIntEntry:
    M8C_EnableIntMask I2C_INT_REG, I2C_INT_MASK
    RAM_EPILOGUE RAM_USE_CLASS_1
    ret

.ENDSECTION

.SECTION
;-----------------------------------------------------------------------------
;  FUNCTION NAME: I2C_ClearInt
;
;  DESCRIPTION:
;     Clears only the I2C interrupt in the INT_CLR3 register.
;
;-----------------------------------------------------------------------------
;
;  ARGUMENTS: none
;
;  RETURNS: none
;
;  SIDE EFFECTS:
;    The A and X registers may be modified by this or future implementations
;    of this function.  The same is true for all RAM page pointer registers in
;    the Large Memory Model.  When necessary, it is the calling function's
;    responsibility to perserve their values across calls to fastcall16 
;    functions.
;          
 I2C_ClearInt:
_I2C_ClearInt:
    RAM_PROLOGUE RAM_USE_CLASS_1
    M8C_ClearIntFlag INT_CLR3, I2C_INT_MASK
    RAM_EPILOGUE RAM_USE_CLASS_1
    ret
    
.ENDSECTION

IF (I2C_MUM_SEL & (I2C_MSTR | I2C_MMS))	
.SECTION
;-----------------------------------------------------------------------------
;  FUNCTION NAME: I2C_EnableMstr
;
;  DESCRIPTION:
;     Enables SDA interrupt allowing start condition detection. Remember to call the
;     global interrupt enable function by using the macro: M8C_EnableGInt.
;
;-----------------------------------------------------------------------------
;
;  ARGUMENTS: none
;
;  RETURNS: none
;
;  SIDE EFFECTS:
;    The A and X registers may be modified by this or future implementations
;    of this function.  The same is true for all RAM page pointer registers in
;    the Large Memory Model.  When necessary, it is the calling function's
;    responsibility to perserve their values across calls to fastcall16 
;    functions.
;          
 I2C_EnableMstr:
_I2C_EnableMstr:
    RAM_PROLOGUE RAM_USE_CLASS_1
	;;CDT 28399
	RAM_SETPAGE_CUR >I2C_bStatus
	and [I2C_bStatus], ~0x80 ;; ~I2C_ISR_ACTIVE
	RAM_SETPAGE_CUR >I2C_RsrcStatus
    and    [I2C_RsrcStatus], ~0x80;;~I2CHW_ISR_ACTIVE        ; Make sure internal control variables weren't corrupted previous to start.
    BitSetI2C_CFG I2C_M_EN                                           ;Enable SDA interupt
    RAM_EPILOGUE RAM_USE_CLASS_1
    ret

.ENDSECTION
ENDIF

IF (I2C_MUM_SEL & (I2C_SLAVE | I2C_MMS))
.SECTION
;-----------------------------------------------------------------------------
;  FUNCTION NAME: I2C_EnableSlave
;
;  DESCRIPTION:
;     Enables SDA interrupt allowing start condition detection. Remember to call the
;     global interrupt enable function by using the macro: M8C_EnableGInt.
;
;-----------------------------------------------------------------------------
;
;  ARGUMENTS: none
;
;  RETURNS: none
;
;  SIDE EFFECTS:
;    The A and X registers may be modified by this or future implementations
;    of this function.  The same is true for all RAM page pointer registers in
;    the Large Memory Model.  When necessary, it is the calling function's
;    responsibility to perserve their values across calls to fastcall16 
;    functions.
;          
 I2C_EnableSlave:
_I2C_EnableSlave:
    RAM_PROLOGUE RAM_USE_CLASS_1
    
    M8C_SetBank1 ;The SDA and SCL pins are setting to Hi-z drive mode
    and reg[I2CSDA_DriveMode_0_ADDR],~(I2CSDA_MASK|I2CSCL_MASK)
    or  reg[I2CSDA_DriveMode_1_ADDR], (I2CSDA_MASK|I2CSCL_MASK)
    M8C_SetBank0
    or  reg[I2CSDA_DriveMode_2_ADDR], (I2CSDA_MASK|I2CSCL_MASK)
   
    BitSetI2C_CFG I2C_S_EN                                           ;Enable SDA interrupt
    nop
    nop
    nop
    nop
    nop
   
    M8C_SetBank1 ;The SDA and SCL pins are restored to Open Drain Low drive mode
    or reg[I2CSDA_DriveMode_0_ADDR], (I2CSDA_MASK|I2CSCL_MASK)
    or reg[I2CSDA_DriveMode_1_ADDR], (I2CSDA_MASK|I2CSCL_MASK)
    M8C_SetBank0
    or reg[I2CSDA_DriveMode_2_ADDR], (I2CSDA_MASK|I2CSCL_MASK)
    
    RAM_EPILOGUE RAM_USE_CLASS_1
    ret

.ENDSECTION
ENDIF

.SECTION
;-----------------------------------------------------------------------------
;  FUNCTION NAME: I2C_DisableInt
;  FUNCTION NAME: I2C_Stop
;
;  DESCRIPTION:
;     Disables I2C slave by disabling SDA interrupt
;
;-----------------------------------------------------------------------------
;
;  ARGUMENTS: none
;
;  RETURNS: none
;
;  SIDE EFFECTS:
;    The A and X registers may be modified by this or future implementations
;    of this function.  The same is true for all RAM page pointer registers in
;    the Large Memory Model.  When necessary, it is the calling function's
;    responsibility to perserve their values across calls to fastcall16 
;    functions.
;          
 I2C_DisableInt:
_I2C_DisableInt:
 I2C_Stop:
_I2C_Stop:
    RAM_PROLOGUE RAM_USE_CLASS_1
    M8C_DisableIntMask I2C_INT_REG, I2C_INT_MASK
    RAM_EPILOGUE RAM_USE_CLASS_1
    ret

.ENDSECTION

IF (I2C_MUM_SEL & (I2C_SLAVE | I2C_MMS))
.SECTION
;-----------------------------------------------------------------------------
;  FUNCTION NAME: I2C_DisableSlave
;
;  DESCRIPTION:
;     Disables I2C slave by disabling SDA interrupt
;
;-----------------------------------------------------------------------------
;
;  ARGUMENTS: none
;
;  RETURNS: none
;
;  SIDE EFFECTS:
;    The A and X registers may be modified by this or future implementations
;    of this function.  The same is true for all RAM page pointer registers in
;    the Large Memory Model.  When necessary, it is the calling function's
;    responsibility to perserve their values across calls to fastcall16 
;    functions.
;          
 I2C_DisableSlave:
_I2C_DisableSlave:
    RAM_PROLOGUE RAM_USE_CLASS_1
    BitClrI2C_CFG I2C_S_EN                                           ;Disable the Slave
    RAM_EPILOGUE RAM_USE_CLASS_1
    ret

.ENDSECTION
ENDIF

IF (I2C_MUM_SEL & (I2C_MSTR | I2C_MMS))
.SECTION
;-----------------------------------------------------------------------------
;  FUNCTION NAME: I2C_DisableMstr
;
;  DESCRIPTION:
;     Disables I2C slave by disabling SDA interrupt
;
;-----------------------------------------------------------------------------
;
;  ARGUMENTS: none
;
;  RETURNS: none
;
;  SIDE EFFECTS:
;    The A and X registers may be modified by this or future implementations
;    of this function.  The same is true for all RAM page pointer registers in
;    the Large Memory Model.  When necessary, it is the calling function's
;    responsibility to perserve their values across calls to fastcall16 
;    functions.
;          
 I2C_DisableMstr:
_I2C_DisableMstr:
    RAM_PROLOGUE RAM_USE_CLASS_1
    BitClrI2C_CFG I2C_M_EN                                           ;Disable the Master
    RAM_EPILOGUE RAM_USE_CLASS_1
   ret

.ENDSECTION
ENDIF

IF (I2C_MUM_SEL & (I2C_SLAVE | I2C_MMS))
 IF (I2C_CY8C22x45)
 .SECTION
;-----------------------------------------------------------------------------
;  FUNCTION NAME: void  I2C_EnableHWAddrCheck(void)
;
;  DESCRIPTION:
;   Set respective bit to engage the HardWare Address Recognition 
;   feature in I2C slave block.
;
;-----------------------------------------------------------------------------
;
;  ARGUMENTS: none
;
;  RETURNS: none
;
;  SIDE EFFECTS:
;    If the HardWare Address Recognition feature is enabled, the ROM registers reading does not work.
;    The HardWare Address Recognition feature should be disabled for using ROM registers.
;
;    The A and X registers may be modified by this or future implementations
;    of this function.  The same is true for all RAM page pointer registers in
;    the Large Memory Model.  When necessary, it is the calling function's
;    responsibility to perserve their values across calls to fastcall16 
;    functions.
;
 I2C_EnableHWAddrCheck:
_I2C_EnableHWAddrCheck:
   RAM_PROLOGUE RAM_USE_CLASS_1
   M8C_SetBank1
   or    reg[I2C_ADDR], I2C_HW_ADDR_EN
   M8C_SetBank0
   RAM_EPILOGUE RAM_USE_CLASS_1
   ret
.ENDSECTION

.SECTION
;-----------------------------------------------------------------------------
;  FUNCTION NAME: void  I2C_DisableHWAddrCheck(void)
;
;  DESCRIPTION:
;   Clear respective bit to disengage the HardWare Address Recognition 
;   feature in I2C slave block.
;
;-----------------------------------------------------------------------------
;
;  ARGUMENTS: none
;
;  RETURNS: none
;
;  SIDE EFFECTS:
;    The A and X registers may be modified by this or future implementations
;    of this function.  The same is true for all RAM page pointer registers in
;    the Large Memory Model.  When necessary, it is the calling function's
;    responsibility to perserve their values across calls to fastcall16 
;    functions.
;
 I2C_DisableHWAddrCheck:
_I2C_DisableHWAddrCheck:
   RAM_PROLOGUE RAM_USE_CLASS_1
   M8C_SetBank1
   and   reg[I2C_ADDR], ~I2C_HW_ADDR_EN
   M8C_SetBank0
   RAM_EPILOGUE RAM_USE_CLASS_1
   ret
.ENDSECTION
 ENDIF
ENDIF

; End of File I2C.asm
